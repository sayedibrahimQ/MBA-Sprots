{% load static %}
{% load i18n %}

<div class="product-card h-100">
    {% if product.discount_active and product.new_price %}
        {% with discount_percentage=product.price|sub:product.new_price|mul:100|div:product.price %}
            {% if discount_percentage > 0 %}
            <span class="sale-badge">-{{ discount_percentage|floatformat:0 }}%</span>
            {% endif %}
        {% endwith %}
    {% endif %}

    {# Wishlist button specific to product cards #}
    <button type="button" class="btn-wishlist-card {% if product.id in wishlist_product_ids %}active{% endif %}"
            data-product-id="{{ product.id }}" 
            onclick="toggleWishlistCard(this)" 
            aria-label="{% if product.id in wishlist_product_ids %}{% trans 'Remove from wishlist' %}{% else %}{% trans 'Add to wishlist' %}{% endif %}">
        <i class="{% if product.id in wishlist_product_ids %}fas{% else %}far{% endif %} fa-heart"></i>
    </button>

    <a href="{% url 'product_detail' product.id %}">
        <img src="{% if product.img %}{{ product.img.url }}{% else %}{% static 'ecommerce/images/placeholder.jpg' %}{% endif %}" 
             class="product-card-img img-fluid" alt="{{ product.name }}">
    </a>

    <div class="product-info">
        <h5><a href="{% url 'product_detail' product.id %}" class="text-decoration-none text-light stretched-link">{{ product.name|truncatechars:50 }}</a></h5>
        
        {# Optional: Short description if available in your product model #}
        {# <p class="product-description-sm text-white-50">{{ product.short_description|truncatewords:10|default:"" }}</p> #}

        <div class="price-area">
            {% if product.discount_active and product.new_price %}
                <span class="price">{{ product.new_price|floatformat:2 }} {% trans "EGP" %}</span>
                <span class="old-price"><del>{{ product.price|floatformat:2 }} {% trans "EGP" %}</del></span>
            {% else %}
                <span class="price">{{ product.price|floatformat:2 }} {% trans "EGP" %}</span>
            {% endif %}
        </div>

        <form class="add-to-cart-card-form mt-auto" method="POST" action="{% url 'ecommerce:add_to_cart' product.id %}">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">
            {% if product.variants.exists %}
                {# For products with variants, default to first available or handle selection via modal #}
                {% with first_variant=product.variants.first %}
                    {% if first_variant %}
                        <input type="hidden" name="variant_id" value="{{ first_variant.id }}">
                    {% endif %}
                {% endwith %}
            {% endif %}
            <input type="hidden" name="quantity" value="1">
            <button type="submit" class="btn-add-to-cart-card" {% if not product.is_active or (product.variants.exists and not product.variants.first.quantity > 0 and not product.variants.filter(quantity__gt=0).exists) %}disabled{% endif %}>
                <i class="fas fa-cart-plus"></i>&nbsp;{% trans "Add to Cart" %}
            </button>
        </form>
    </div>
</div>

<script>
// This script block is for potential future use if product cards need individual JS,
// but core logic like wishlist and add-to-cart (for cards) is handled by global functions
// in product_detail.html or base.html to avoid repetition and ensure CSRF token is present.

// Example of how a card-specific add-to-cart might look (ensure it doesn't conflict with product_detail page JS)
/*
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.add-to-cart-card-form').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const productId = formData.get('product_id');
            const variantId = formData.get('variant_id'); // Might be null
            const button = this.querySelector('.btn-add-to-cart-card');
            const originalButtonHtml = button.innerHTML;

            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            button.disabled = true;

            // Global showNotification and CSRF token should be accessible
            // const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value; // Or from a global JS var

            fetch("{% url 'add_to_cart' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': '{{ csrf_token }}' } // Ensure this var is passed or globally available
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (window.showNotification) showNotification(data.message || '{% trans "Added!" %}', 'success');
                    const cartBadge = document.getElementById('cart-item-count-badge');
                    if (cartBadge && data.cart_item_count !== undefined) {
                        cartBadge.textContent = data.cart_item_count;
                        cartBadge.classList.toggle('d-none', data.cart_item_count === 0);
                    }
                } else {
                    if (window.showNotification) showNotification(data.message || '{% trans "Error." %}', 'danger');
                }
            })
            .catch(error => {
                console.error('Card Add to Cart Error:', error);
                if (window.showNotification) showNotification('{% trans "Request failed." %}', 'danger');
            })
            .finally(() => {
                button.innerHTML = originalButtonHtml;
                button.disabled = false; // Or re-evaluate based on stock
            });
        });
    });
});
*/
</script> 